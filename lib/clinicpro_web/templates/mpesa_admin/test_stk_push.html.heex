<div class="container mx-auto px-4 py-8">
  <div class="bg-white rounded-lg shadow-lg p-6">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-bold">Test STK Push</h1>
      <a
        href={Routes.mpesa_admin_path(@conn, :index, @clinic_id)}
        class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          viewBox="0 0 20 20"
          fill="currentColor"
        >
          <path
            fill-rule="evenodd"
            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
            clip-rule="evenodd"
          />
        </svg>
        Back to Configurations
      </a>
    </div>

    <div class="bg-gray-50 p-4 rounded-lg mb-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <span class="inline-flex items-center justify-center h-12 w-12 rounded-md bg-indigo-100 text-indigo-600">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
          </span>
        </div>
        <div class="ml-4">
          <h2 class="text-lg font-medium text-gray-900">
            M-Pesa Configuration: {@config.shortcode}
            <span class={"ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full #{environment_badge(@config.environment)}"}>
              {String.upcase(@config.environment)}
            </span>
          </h2>
          <p class="text-sm text-gray-500">
            {if @config.active do}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <svg
                  class="-ml-0.5 mr-1.5 h-2 w-2 text-green-400"
                  fill="currentColor"
                  viewBox="0 0 8 8"
                >
                  <circle cx="4" cy="4" r="3" />
                </svg>
                Active
              </span>
            <% else %>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                <svg
                  class="-ml-0.5 mr-1.5 h-2 w-2 text-gray-400"
                  fill="currentColor"
                  viewBox="0 0 8 8"
                >
                  <circle cx="4" cy="4" r="3" />
                </svg>
                Inactive
              </span>
            <% end %>
            | Last updated: {format_date_time(@config.updated_at)}
          </p>
        </div>
      </div>
    </div>

    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg
            class="h-5 w-5 text-yellow-400"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
              clip-rule="evenodd"
            />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-yellow-700">
            <strong>Note:</strong>
            This will initiate a real STK Push request to the phone number provided.
            {if @config.environment == "sandbox" do}
              Since this is a sandbox environment, no actual money will be deducted.
            <% else %>
              <strong>
                This is a production environment and will deduct real money from the provided phone number.
              </strong>
            <% end %>
          </p>
        </div>
      </div>
    </div>

    {form_for @changeset, Routes.mpesa_admin_path(@conn, :process_stk_push_test, @config.id), fn f ->}
      <div class="space-y-6">
        <div class="bg-white shadow px-4 py-5 sm:rounded-lg sm:p-6">
          <div class="md:grid md:grid-cols-3 md:gap-6">
            <div class="md:col-span-1">
              <h3 class="text-lg font-medium leading-6 text-gray-900">Payment Details</h3>
              <p class="mt-1 text-sm text-gray-500">
                Enter the phone number and amount to test the STK Push functionality.
              </p>
            </div>
            <div class="mt-5 md:mt-0 md:col-span-2">
              <div class="grid grid-cols-6 gap-6">
                <div class="col-span-6 sm:col-span-3">
                  <%= label(f, :phone_number, "Phone Number",
                    class: "block text-sm font-medium text-gray-700"
                  ) %>
                  <div class="mt-1 relative rounded-md shadow-sm">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 sm:text-sm">
                      +254
                    </span>
                    <%= text_input(f, :phone_number,
                      class:
                        "pl-14 focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md",
                      placeholder: "7XXXXXXXX"
                    ) %>
                  </div>
                  <p class="mt-2 text-sm text-gray-500">
                    Enter the phone number without the country code (e.g., 7XXXXXXXX)
                  </p>
                  {error_tag(f, :phone_number)}
                </div>

                <div class="col-span-6 sm:col-span-3">
                  {label(f, :amount, class: "block text-sm font-medium text-gray-700")}
                  <div class="mt-1 relative rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                      <span class="text-gray-500 sm:text-sm">KES</span>
                    </div>
                    <%= number_input(f, :amount,
                      class:
                        "pl-12 focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md",
                      placeholder: "1.00",
                      min: "1",
                      step: "0.01"
                    ) %>
                  </div>
                  <p class="mt-2 text-sm text-gray-500">Minimum amount is KES 1.00</p>
                  {error_tag(f, :amount)}
                </div>

                <div class="col-span-6">
                  <%= label(f, :reference, "Reference (Optional)",
                    class: "block text-sm font-medium text-gray-700"
                  ) %>
                  <%= text_input(f, :reference,
                    class:
                      "mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",
                    placeholder: "Test Payment"
                  ) %>
                  <p class="mt-2 text-sm text-gray-500">
                    A reference for this test payment (defaults to "Test Payment" if left blank)
                  </p>
                  {error_tag(f, :reference)}
                </div>

                <div class="col-span-6">
                  <%= label(f, :description, "Description (Optional)",
                    class: "block text-sm font-medium text-gray-700"
                  ) %>
                  <%= text_input(f, :description,
                    class:
                      "mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md",
                    placeholder: "Test STK Push"
                  ) %>
                  <p class="mt-2 text-sm text-gray-500">
                    A description for this test payment (defaults to "Test STK Push" if left blank)
                  </p>
                  {error_tag(f, :description)}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end">
          <a
            href={Routes.mpesa_admin_path(@conn, :index, @clinic_id)}
            class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-3"
          >
            Cancel
          </a>
          <%= submit("Send STK Push",
            class:
              "inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          ) %>
        </div>
      </div>
    <% end %>

    {if @recent_transactions && length(@recent_transactions) > 0 do}
      <div class="mt-8">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Test Transactions</h3>
        <div class="bg-white shadow overflow-hidden sm:rounded-md">
          <ul class="divide-y divide-gray-200">
            {for transaction <- @recent_transactions do}
              <li>
                <a
                  href={Routes.mpesa_admin_path(@conn, :transaction_details, transaction.id)}
                  class="block hover:bg-gray-50"
                >
                  <div class="px-4 py-4 sm:px-6">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center">
                        <p class="text-sm font-medium text-indigo-600 truncate">
                          {transaction.reference}
                        </p>
                        <div class="ml-2 flex-shrink-0 flex">
                          <p class={"px-2 inline-flex text-xs leading-5 font-semibold rounded-full #{transaction_status_class(transaction.status)}"}>
                            {format_transaction_status(transaction.status)}
                          </p>
                        </div>
                      </div>
                      <div class="ml-2 flex-shrink-0 flex">
                        <p class="text-sm text-gray-500">
                          {format_amount(transaction.amount)}
                        </p>
                      </div>
                    </div>
                    <div class="mt-2 sm:flex sm:justify-between">
                      <div class="sm:flex">
                        <p class="flex items-center text-sm text-gray-500">
                          <svg
                            class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400"
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                          >
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                          </svg>
                          {format_phone(transaction.phone)}
                        </p>
                      </div>
                      <div class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0">
                        <svg
                          class="flex-shrink-0 mr-1.5 h-5 w-5 text-gray-400"
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                            clip-rule="evenodd"
                          />
                        </svg>
                        <p>
                          {format_date_time(transaction.inserted_at)}
                        </p>
                      </div>
                    </div>
                  </div>
                </a>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
  </div>
</div>
